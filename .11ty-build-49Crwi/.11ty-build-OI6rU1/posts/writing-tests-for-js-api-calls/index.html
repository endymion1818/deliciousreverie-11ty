<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to test JavaScript API Calls</title>
    <meta name="description" content="In the January 2020 issue of Net Magazine, we walked through how to use React testing library to write basic unit tests for your React components. In this article I&#39;m going to dive a little deeper and show how to write tests for some code that fetches data from an API.">
    <meta property="og:site_name" content="How to test JavaScript API Calls">
    <meta property="og:locale" content="en_GB">
    <meta property="og:type" content="website">
    <meta property="og:description" content="In the January 2020 issue of Net Magazine, we walked through how to use React testing library to write basic unit tests for your React components. In this article I&#39;m going to dive a little deeper and show how to write tests for some code that fetches data from an API.">
    <meta property="og:title" content="How to test JavaScript API Calls" />
    <meta property="og:image" content="/img/sharecard-default.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@muzzlehatch_" />
    <meta name="twitter:title" content="How to test JavaScript API Calls" />
    <meta
      name="twitter:description"
      content="In the January 2020 issue of Net Magazine, we walked through how to use React testing library to write basic unit tests for your React components. In this article I&#39;m going to dive a little deeper and show how to write tests for some code that fetches data from an API."
    />
    <meta name="twitter:image" content="/img/sharecard-default.png" />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        "headline": "How to test JavaScript API Calls",
        "author": {
          "@type": "Person",
          "name": "Benjamin Read"
        },
        "datePublished": "2020-04-09T11:21:21+01:00",
        "image": "/img/sharecard-default.png"
      }
    </script>
    <link rel="icon" href="/img/icon.png" type="image/x-icon">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Delicious Reverie">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Delicious Reverie">
  </head>
  <body>
    <a id="skiplinks" href="#main">Skip to main content</a>
    <p class="themeswitcher">Choose theme:</p>
    <label class="themeswitcher" for="dark">Light</label>
    <input class="themeswitcher" type="radio" id="light" name="colors" value="light">
    <label  class="themeswitcher" for="dark">Dark</label>
    <input  class="themeswitcher" type="radio" id="dark" name="colors" value="dark">
    <header>
      <div class="container">
        <div class="title home"><a href="/">Delicious Reverie</a></div>
        <p class="subtitle">blog of developer &amp; bookworm benjamin read</p>
        <nav>
          <ul class="list-inline">
            <li class="nav-item">
              <a href="/">Home</a>
            </li>
            <li class="nav-item">
              <a href="/about/">About</a>
            </li>
            <li class="nav-item">
              <a href="/links/">Links</a>
            </li>
            <li class="nav-item">
              <a href="/posts/">Archive</a>
            </li>
            <li class="nav-item">
              <a href="/contact/">Contact</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="main tmpl-post">
      
      <div class="container">
        <h1>How to test JavaScript API Calls</h1>

<time datetime="2020-04-09">09 Apr 2020</time><a href="/tags/javascript/" class="post-tag">javascript</a><a href="/tags/testing/" class="post-tag">testing</a>

<p><strong>In the January 2020 issue of Net Magazine, we walked through how to use React testing library to write basic unit tests for your React components. In this article I'm going to dive a little deeper and show how to write tests for some code that fetches data from an API.</strong></p>
<p>This is an important distinction from what we covered previously because writing tests for UI components is very different from tests like this, and I hope that you'll learn some more things to help you ensure that <em>all</em> of your code is production ready, which will give you and your stakeholders more confidence when publishing new code.</p>
<h2 id="step-0.-decide-what-to-test" tabindex="-1">Step 0. Decide What to Test <a class="direct-link" href="#step-0.-decide-what-to-test" aria-hidden="true">#</a></h2>
<p>Before we even begin writing tests it's good to decide <em>what</em> needs to be tested. We need to set clear boundaries before we begin, otherwise we could waste time writing tests unnecessarily. Read through your code and see what different outcomes might be generated by your code.</p>
<p>In our example of fetching data from an API, the API call could be successful, that counts as one outcome. But what if it's not successful? And what should happen if the call is successful, but it returns no data? That's three different possible outcomes already!</p>
<p>Let's look at our imaginary API call to see what outcomes exist. Here's the code we're going to test:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> env <span class="token keyword">from</span> <span class="token string">"./ENV"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">getApiData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">parameters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> domain <span class="token operator">=</span> env<span class="token punctuation">.</span>domain</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>  axios<br>    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/v1/data/?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parameters<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// handle success</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">return</span> data<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// handle error</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Looking at my code, I can see the following outcomes:</p>
<ol>
<li>Fetch api data</li>
<li>Fetch data with parameters specified</li>
<li>Return the data if the call was successful</li>
<li>Return an empty array if no data was received</li>
<li>Log an error if the request was unsuccessful</li>
</ol>
<p>Looking at your code in the beginning like this often reveals other issues to you that you may not have noticed before, and which prompts you to revisit your original code and improve it.</p>
<p>Let's handle the first 4 tests first, then come back to the last two and see how we can improve our code.</p>
<p>To begin, I'll create a new file to write my tests in. The name of the file is usually the same as the module. So if my module is called <strong>GetApiData.js</strong>, my test should be <strong>GetApiData.test.js</strong>.</p>
<h2 id="setup-and-mocking" tabindex="-1">Setup and Mocking <a class="direct-link" href="#setup-and-mocking" aria-hidden="true">#</a></h2>
<h3 id="1.-mock-the-api" tabindex="-1">1. Mock the API <a class="direct-link" href="#1.-mock-the-api" aria-hidden="true">#</a></h3>
<p>Although this test is about fetching data from the API, I don't want to actually call the data from the API. There are several reasons for this: Primarily, it's because I'm not testing the API, I'm testing the code I have written. But also there could be a cost involved each time I contact the API, I don't want or need that cost to be incurred. Finally, I don't want to wait for the API query to resolve for my tests to finish!</p>
<p>To do that, I'm going to &quot;mock&quot; this function. When you &quot;mock&quot; something you essentially overwrite the function with a fake function. Let's first import the code that was written to fetch data from that API, and also the library that we used to connect to the API, Axios:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> GetApiData <span class="token keyword">from</span> <span class="token string">"./GetApiData"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span></code></pre>
<p>After importing it, we can overwrite the functionality of axios like this:</p>
<pre class="language-javascript"><code class="language-javascript">jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">"axios"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> mockedAxios <span class="token operator">=</span> axios<span class="token punctuation">.</span>get<span class="token punctuation">;</span></code></pre>
<p>Now, every time we call GetApiData in this file, and that calls Axios, it'll use our mocked implementation. Using it in the variable <code>mockedAxios</code> will help us identify clearly what we're doing when we write our tests.</p>
<p>The last thing we want to set up in regard to our API is the domain. This would be a parameter that is passed via our configuration, or part of our environment variables. But we're not testing our environment variables, so we should mock that domain too:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> domain <span class="token operator">=</span> <span class="token string">"https://fakeapi.com/"</span><span class="token punctuation">;</span></code></pre>
<h3 id="2.-mock-the-console" tabindex="-1">2. Mock the console <a class="direct-link" href="#2.-mock-the-console" aria-hidden="true">#</a></h3>
<p>The next thing we want to mock is what we would have used in our code to log out errors: <code>console.log()</code>, for similar reasons we mentioned above: we're not testing the functionality of the console. Also, we don't want to actually log the errors to the console as we're running tests, but instead somewhere we can test the output.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> mockedConsole <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>console<span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>By using Jest's <code>SpyOn</code> function, we can examine when that function was called, and what it was called with ... it's actually is a spy function, reporting back to us (thankfully!).</p>
<h3 id="3.-mock-the-data-that-should-be-returned" tabindex="-1">3. Mock the data that should be returned <a class="direct-link" href="#3.-mock-the-data-that-should-be-returned" aria-hidden="true">#</a></h3>
<p>Finally, because we're not contacting the api, we need to provide mocked data to test against as if though it did:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> mockedDataOne <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1234</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"Super Blog Post"</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">_embedded</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">term</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Category"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Author"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> mockedDataTwo <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">165</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"Super Post Two"</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token literal-property property">_embedded</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">term</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Category"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">author</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Author"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>Right! Let's begin our tests with a wrapping description:</p>
<pre><code>describe('GetApiData() Source data so we can consume it', () =&gt; {
</code></pre>
<h3 id="4.-clean-ups" tabindex="-1">4. Clean ups <a class="direct-link" href="#4.-clean-ups" aria-hidden="true">#</a></h3>
<p>Last piece of setup here: we want to reset our mocked API call and console log before each new test, otherwise we'll have stale data left over from the previous test, which could cause subsequent tests to fail:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  mockedAxios<span class="token punctuation">.</span><span class="token function">mockReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  mockedConsole<span class="token punctuation">.</span><span class="token function">mockReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Right, now we've set up our tests, and mocked the important stuff, let's dive into our first test ...</p>
<h2 id="test-1:-fetch-api-data" tabindex="-1">Test 1: Fetch api data <a class="direct-link" href="#test-1:-fetch-api-data" aria-hidden="true">#</a></h2>
<p>Let's begin our tests with a wrapping description:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GetApiData()'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code></pre>
<p>This wrapping function describes the component, or makes a short statement to help us understand what these tests are for. If your function name adequately describes what it does, and you don't need a longer description, that's a good sign that you have named your function well!</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Should get api data"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  mockedAxios<span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token string">"Hi I worked!"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getApiData</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>mockedAxios<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>First thing to note: this is an <em>asynchronous</em> function! <code>axios.get</code> is already an async function so it makes sense to test it asynchronously too. It's best to make api calls async because you have a callback even if something fails, rather than the request simply hanging indefinitely, which is bad for user experience.</p>
<p><code>mockResolvedValueOnce()</code> is a built-in function in Jest that, well, mocks the resolved value of the API call just once.</p>
<p>Here we're mocking the <em>result</em> of the mocked axios call. We're not testing the <em>contents</em> of the data, so I've just added a dummy object to the result of the <code>mockResolvedValueOnce()</code> function, since that's adequate for what we're testing.</p>
<p>You can now run this test, and you should see 1 passing test. Go you!</p>
<p>So ... it worked! We can stop there right?</p>
<p>Well ... how do we know our code contacted the right API endpoint? How do we know it sent the correct parameters, if we need any?</p>
<h2 id="test-2:-return-the-data-if-the-call-was-successful" tabindex="-1">Test 2: Return the data if the call was successful <a class="direct-link" href="#test-2:-return-the-data-if-the-call-was-successful" aria-hidden="true">#</a></h2>
<p>Our next test will check that we have the data we expected in the return value of the <code>GetApiData()</code> function:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should get data from the api'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	mockedAxios<span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span> mockedDataOne<span class="token punctuation">,</span> mockedDataTwo <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>This time we're mocking the return value containing the two objects we originally set up.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getApiData</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">expect</span><span class="token punctuation">(</span>mockedAxios<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Just as before, I like to check that we did actually call the <code>mockedAxios</code> function. Next I'm going to check one of the data objects to make sure it has the same <code>id</code> as <code>mockedDataOne</code>:</p>
<pre class="language-javascript"><code class="language-javascript">  <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><br>  expect<span class="token punctuation">.</span><span class="token function">objectContaining</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      <span class="token literal-property property">id</span><span class="token operator">:</span> mockedDataOne<span class="token punctuation">.</span>id<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>You could do more tests, perhaps making sure that <code>data[1]</code> also has the corresponding ID, but this is enough to convince me that the data is returning correctly.</p>
<p>Now this does seem a little ... &quot;circular&quot; at first. You might think &quot;of course it contains it! That's what you told it to contain!&quot;, but think about it for a minute: we haven't <em>just</em> returned that data. We've used <em>our preexisting code</em> (minus the actual API calls and real data) to return it. It's like throwing a ball, then our code caught it, and threw it back.</p>
<p>If nobody threw our ball back, then something is very wrong with the code we're testing: it's not working as we expected.</p>
<h2 id="test-3:-fetch-data-with-parameters-specified" tabindex="-1">Test 3: Fetch data with parameters specified <a class="direct-link" href="#test-3:-fetch-data-with-parameters-specified" aria-hidden="true">#</a></h2>
<p>Here's our next assertion. We want to make sure our code passed the parameters we wanted, and returned the value we expected.</p>
<pre class="language-javascript"><code class="language-javascript">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should get data using parameters'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span></code></pre>
<p>So this time our <code>params</code> contain an array specifying category 2 should be fetched. Remember we mocked some data in our setup? How many of those mocked data sets has the category of <code>2</code>? Only one of them:<code>mockedDataTwo</code>.</p>
<pre class="language-javascript"><code class="language-javascript">    mockAxios<span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> mockedDataTwo <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token keyword">await</span> <span class="token function">GetApiData</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> params<span class="token punctuation">)</span><br><br>    <span class="token function">expect</span><span class="token punctuation">(</span>mockAxios<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token function">expect</span><span class="token punctuation">(</span>mockAxios<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/v1/data/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token literal-property property">categories</span><span class="token operator">:</span> params<span class="token punctuation">.</span>categories<span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Okay, so if this test passes, our code is passing the categories correctly. Great! But does the data reflect that?</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><br>  expect<span class="token punctuation">.</span><span class="token function">objectContaining</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>If this test passes, then great! We have successfully obtained data with the correct parameters.</p>
<p>Another check to do here is that the data <em>only</em> contains items with this category, and not any other. I'll leave that one for you to figure out.</p>
<p>These next two tests are to verify we have captured two significant <em>branches</em>, or outcomes, of our code: failures.</p>
<h2 id="test-4:-return-an-empty-object-if-no-data-was-recieved" tabindex="-1">Test 4: Return an empty object if no data was recieved <a class="direct-link" href="#test-4:-return-an-empty-object-if-no-data-was-recieved" aria-hidden="true">#</a></h2>
<p>If there hasn't been any data sent back to us after the API call, we have returned an array as a fallback so that we don't have an exception in our data layer. that can be used by our UI to provide a fallback - once the API call has been resolved.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Should return an empty array if no data was recieved"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetApiData</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  mockAxios<span class="token punctuation">.</span><span class="token function">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">expect</span><span class="token punctuation">(</span>mockAxios<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toBeTruthy<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>We're mocking a data object with a <code>null</code> value here to represent no values being returned from the API call. We're using <code>Array.isArray</code> because that is far more robust than using <code>isArray</code>, which is an older method that returns <code>true</code> for a number of different cases (don't ask...).</p>
<h2 id="test-5:-log-an-error-if-the-request-was-unsuccessful" tabindex="-1">Test 5: Log an error if the request was unsuccessful <a class="direct-link" href="#test-5:-log-an-error-if-the-request-was-unsuccessful" aria-hidden="true">#</a></h2>
<p>Logging errors is a vital part of a robust application. It's a great way of being able to respond to API failures or application exceptions before users get to see them. In this test, I'm just going to check for a <code>console.log()</code> call, but in a production app, there would be an integration with some external logging system that would send an email alert to the dev team if it was a critical error:</p>
<p>Our final test uses our <code>consoleMock</code> from our initial setup (see above):</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"Should log an error if the request was unsuccessful"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"there was an error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  mockAxios<span class="token punctuation">.</span><span class="token function">mockRejectedValue</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">await</span> <span class="token function">GetApiData</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">expect</span><span class="token punctuation">(</span>mockAxios<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>mockedConsole<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">expect</span><span class="token punctuation">(</span>mockedConsole<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>the <code>consoleMock</code> function allows us to mock the functionality of the console.log object. Because we're testing that an error is thrown by our code, we need to use the <code>Error</code> object to test the output correctly.</p>
<p>So there we are ... we now have a suite of tests to give us more confidence that our code is production ready ... as long as the tests don't fail in our pipeline, we can be confident that we have met the core criteria for our <code>GetApiData</code> function.</p>
<h2 id="conclusion" tabindex="-1">Conclusion <a class="direct-link" href="#conclusion" aria-hidden="true">#</a></h2>
<p>There's a lot to these functions and it can take quite a bit of time to get used to writing this much code:- more than our actual function! But what is the price of confidence? ... if you think about it, by spending the time writing this code, we could have saved our company hundreds of thousands of pounds from lost income if it was broken!</p>
<p>I would say that thoroughly testing your code is an important step, along with static typing, quality checking, and pre-release validation, to ensuring that your code is indeed production ready!</p>
<div class="boxout">
<h2 id="boxout:-the-price-of-confidence" tabindex="-1">Boxout: The price of confidence <a class="direct-link" href="#boxout:-the-price-of-confidence" aria-hidden="true">#</a></h2>
<p>Developers will spend more time writing tests than writing the components they’re building. That makes sense if you think about it: you need to test every possible outcome of the code that’s being written. As is demonstrated in this article, one API call with some basic functionality can result in a number of differing outcomes.</p>
<p>The benefit of adding tests to your code can easily override the time spent by developers following this practice. If your business or customers needs the confidence that things won’t break, then testing is definitely a good practice to introduce at the start of a project.</p>
<p>Other ways that testing can benefit a project include during refactors. Often project requirements will change after the code has been written. That introduces more risk into the codebase because on revisiting the code a developer might decide to refactor to make it simpler … which could include deleting things that were actually needed! Looking at the test serves as documentation: developers can see that there was a decision behind every code outcome that has been written.</p>
</div>
<br/><br/>
<div class="boxout">
<h2 id="boxout:-scoping-outcomes" tabindex="-1">Boxout: Scoping outcomes <a class="direct-link" href="#boxout:-scoping-outcomes" aria-hidden="true">#</a></h2>
<p>The hardest part of finding out what to test is knowing what your code actually does. This becomes harder with the more time that passes between when you write tests to when you write the actual code. So I recommend writing tests alongside the component, or even before you write your component.</p>
<p>When you’re doing this you’ll be more clearly able to think about all of the different outcome possibilities that your code offers: what variables might change? What different return values are possible?</p>
<p>I’ve used an API call in this example because there’s plenty of variety in what can happen … but I’ve still missed out one valuable test … can you spot which test I haven’t done?</p>
</div>

<hr>
<ul><li>Next: <a href="/posts/creating-homepage-animation/">Creating my homepage animation</a></li><li>Previous: <a href="/posts/learning-serverless-with-webiny/">Learning serverless with Webiny</a></li>
</ul>

      </div>
    </main>

    <footer>
        <div class="footer-top">
          <div class="container">
            <blockquote>
              <span class="title">“Wisest are they who know they do not know.”</span>
              <attr>
                &mdash; Jostein Gaarder
              </attr>
            </blockquote>
          </div>
        </div>
        <div class="footer-bottom">
          <div class="container">
            <h2>About This Site</h2>
            <p><a href="/">Delicious Reverie</a> is the blog of developer & bookworm <span class="h-card">benjamin read</span>. Set in Lovechild and your system font. Built with <a href="https://www.11ty.dev">Eleventy</a> and <a href="https://slinkity.dev">Slinkity</a>, hosted by Netlify. &copy; Some rights are reserved. This site doesn't use any cookies or other session storage and has no tracking scripts.</p>
          <h3>Where you can find me:</h3>
            <ul class="list-inline">
              <li><a href="https://twitter.com/muzzlehatch_">twitter</a></li>
              <li><a href="https://www.linkedin.com/in/benjaminread1980/">linkedin</a></li>
              <li><a href="https://github.com/endymion1818/">github</a></li>
              <li><a href="/feed.xml">RSS Feed</a></li>
            </ul>
          </div>
        </div>
    </footer>
  </body>
</html>
